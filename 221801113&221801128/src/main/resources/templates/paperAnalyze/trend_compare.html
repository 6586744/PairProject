<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="ThemeBucket">
    <link rel="shortcut icon" href="#" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <title>Basic Table</title>

    <div th:include="common :: commonheader"></div>
</head>

<body class="sticky-header" onload="myfun()">
    <section>
        <div th:replace="common :: #leftmenu"></div>

        <div class="main-content">
            <div th:replace="common :: #headermenu"></div>

            <div class="wrapper">
                <h5>请等待动画效果加载</h5>
                <div id="main" style="width: 100%;height: 700px;max-width: 90%;margin-left: 100px"></div>
            </div>

        </div>
    </section>

    <div th:include="common :: #commonscript"></div>

    <script>
        function myfun(){
            console.log('http://localhost:8080/json1');
            console.log('http://localhost:8080/json2');
            var chartDom = document.getElementById('main');
            var myChart = echarts.init(chartDom);
            var option;

            var updateFrequency = 5000;
            var dimension = 0;

            var countryColors = {"Australia":"#00008b","Canada":"#f00","China":"#ffde00","Cuba":"#002a8f","Finland":"#003580","France":"#ed2939","Germany":"#000","Iceland":"#003897","India":"#f93","Japan":"#bc002d","North Korea":"#024fa2","South Korea":"#000","New Zealand":"#00247d","Norway":"#ef2b2d","Poland":"#dc143c","Russia":"#d52b1e","Turkey":"#e30a17","United Kingdom":"#00247d","United States":"#b22234"};

            $.when(
                $.getJSON('http://localhost:8080/json1'),
                $.getJSON('http://localhost:8080/json2')
            ).done(function (res0, res1) {
                var flags = res0[0];
                var data = res1[0];
                var years = [];
                for (var i = 0; i < data.length; ++i) {
                    if (years.length === 0 || years[years.length - 1] !== data[i][4]) {
                        years.push(data[i][4]);
                    }
                }

                function getFlag(countryName) {
                    if (!countryName) {
                        return '';
                    }
                    return (flags.find(function (item) {
                        return item.name === countryName;
                    }) || {}).emoji;
                }
                var startIndex = 0;
                var startYear = years[startIndex];

                var option = {
                    grid: {
                        top: 10,
                        bottom: 30,
                        left: 150,
                        right: 50
                    },
                    xAxis: {
                        max: 'dataMax',
                        label: {
                            formatter: function (n) {
                                return Math.round(n);
                            }
                        }
                    },
                    dataset: {
                        source: data.slice(1).filter(function (d) {
                            return d[4] === startYear;
                        })
                    },
                    yAxis: {
                        type: 'category',
                        inverse: true,
                        max: 9,
                        axisLabel: {
                            show: true,
                            textStyle: {
                                fontSize: 14
                            },
                            formatter: function (value) {
                                return value + '{flag|' + getFlag(value) + '}';
                            },
                            rich: {
                                flag: {
                                    fontSize: 1,
                                    padding: 5
                                }
                            }
                        },
                        animationDuration: 300,
                        animationDurationUpdate: 300
                    },
                    series: [{
                        realtimeSort: true,
                        seriesLayoutBy: 'column',
                        type: 'bar',
                        itemStyle: {
                            color: function (param) {
                                return countryColors[param.value[3]] || '#5470c6';
                            }
                        },
                        encode: {
                            x: dimension,
                            y: 3
                        },
                        label: {
                            show: true,
                            precision: 1,
                            position: 'right',
                            valueAnimation: true,
                            fontFamily: 'monospace'
                        }
                    }],
                    // Disable init animation.
                    animationDuration: 0,
                    animationDurationUpdate: updateFrequency,
                    animationEasing: 'linear',
                    animationEasingUpdate: 'linear',
                    graphic: {
                        elements: [{
                            type: 'text',
                            right: 160,
                            bottom: 60,
                            style: {
                                text: startYear,
                                font: 'bolder 80px monospace',
                                fill: 'rgba(100, 100, 100, 0.25)'
                            },
                            z: 100
                        }]
                    }
                };

                // console.log(option);
                myChart.setOption(option);

                for (var i = startIndex; i < years.length - 1; ++i) {
                    (function (i) {
                        setTimeout(function () {
                            updateYear(years[i + 1]);
                        }, (i - startIndex) * updateFrequency);
                    })(i);
                }

                function updateYear(year) {
                    var source = data.slice(1).filter(function (d) {
                        return d[4] === year;
                    });
                    option.series[0].data = source;
                    option.graphic.elements[0].style.text = year;
                    myChart.setOption(option);
                }
            })

            option && myChart.setOption(option);

        }

    </script>

</body>

</html>